{% extends "lgc/base.html" %}
{% load static %}
{% load crispy_forms_tags %}
{% load i18n %}
{% load l10n %}
{% load custom_tags %}

{% block content %}
<div id="frame">
  <div id="sidepanel">
    <div id="profile">
      <div class="wrap">
	<img id="profile-img" src="{% static 'chat/default-avatar.jpg' %}" class="online" alt="" />
	<p>{{ request.user.first_name }} {{ request.user.last_name }}</p>
	<!-- i class="fa fa-chevron-down expand-button" aria-hidden="true"></i-->
	<div id="status-options">
	  <ul class="nolist">
	    {% chat_get_statuses as statuses %}
	    {% for s in statuses %}
	    {% chat_convert_status s.0 as css_s %}
	    <li id="status-{{ css_s }}" class="active">
	      <span class="status-circle"></span> <p>{{ s.1 }}</p></li>
	    {% endfor %}
	  </ul>
	</div>
	<!--div id="expanded">
	  <label for="twitter"><i class="fab fa-facebook-f" aria-hidden="true"></i></label>
	  <input name="twitter" type="text" value="mikeross" />
	  <label for="twitter"><i class="fab fa-twitter" aria-hidden="true"></i></label>
	  <input name="twitter" type="text" value="ross81" />
	  <label for="twitter"><i class="fab fa-instagram" aria-hidden="true"></i></label>
	  <input name="twitter" type="text" value="mike.ross" />
	</div-->
      </div>
    </div>
    <div id="search">
      <label for=""><i class="fa fa-search" aria-hidden="true"></i></label>
      <input type="text" placeholder="Search contacts..." />
    </div>
    <div id="contacts">
      <ul class="nolist" id="contact_list_id">
	{% for u in users %}
	{% if u.id != request.user.id %}
	<li class="contact" onclick="set_active(this, {{ u.id }})">
	  <div class="wrap">
	    <span class="contact-status {{ u.get_chat_css_status }}"></span>
	    <img src="{% static 'chat/default-avatar.jpg' %}" alt="{{ u.first_name }} {{ u.last_name }}" />
	    <div class="meta">
	      <p class="name">{{ u.first_name }} {{ u.last_name }}</p>
	      <!--p class="preview"></p-->
	    </div>
	  </div>
	</li>
	{% endif %}
	{% endfor %}
      </ul>
    </div>
    <!--div id="bottom-bar">
      <button id="addcontact"><i class="fa fa-user-plus fa-fw" aria-hidden="true"></i> <span>Add contact</span></button>
      <button id="settings"><i class="fa fa-cog fa-fw" aria-hidden="true"></i> <span>Settings</span></button>
    </div-->
  </div>
  <div class="content">
    <div class="contact-profile">
      <img src="{% static 'chat/default-avatar.jpg' %}" alt="" />
      <p style="line-height:60px;" id="contact_name_id"></p>
      <!--div class="social-media">
	<i class="fab fa-facebook-f" aria-hidden="true"></i>
	<i class="fab fa-twitter" aria-hidden="true"></i>
	<i class="fab fa-instagram" aria-hidden="true"></i>
      </div-->
    </div>
    <div class="messages" id="message_box_id">
    </div>
    <div class="message-input">
      <div class="wrap">
	<input type="text" placeholder="{% trans 'Write your message...' %}" />
	<!--i class="fa fa-paperclip attachment" aria-hidden="true"></i-->
	<button class="submit"><i class="fa fa-paper-plane" aria-hidden="true"></i></button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block javascript %}
<script >$(".messages").animate({ scrollTop: $(document).height() }, "fast");

 $("#profile-img").click(function() {
   $("#status-options").toggleClass("active");
 });

 $(".expand-button").click(function() {
   $("#profile").toggleClass("expanded");
   $("#contacts").toggleClass("expanded");
 });

 $("#status-options ul li").click(function() {
   $("#profile-img").removeClass();
   $("#status-online").removeClass("active");
   $("#status-away").removeClass("active");
   $("#status-busy").removeClass("active");
   $("#status-offline").removeClass("active");
   $(this).addClass("active");

   if($("#status-online").hasClass("active")) {
     $("#profile-img").addClass("online");
   } else if ($("#status-away").hasClass("active")) {
     $("#profile-img").addClass("away");
   } else if ($("#status-busy").hasClass("active")) {
     $("#profile-img").addClass("busy");
   } else if ($("#status-offline").hasClass("active")) {
     $("#profile-img").addClass("offline");
   } else {
     $("#profile-img").removeClass();
   };

   $("#status-options").removeClass("active");
 });

 function newMessage() {
   message = $(".message-input input").val();
   message = message.replace(/<[^>]*>?/gm, '');

   if($.trim(message) == '') {
     return false;
   }
   $('<li class="sent"><img src="{% static 'chat/default-avatar.jpg' %}" alt="" /><p>' + message + '</p></li>').appendTo($('.messages ul'));
   $('.message-input input').val(null);
   $('.contact.active .preview').html('<span>You: </span>' + message);
   $(".messages").animate({ scrollTop: $(document).height() }, "fast");
 };

 $('.submit').click(function() {
   newMessage();
 });

 $(window).on('keydown', function(e) {
   if (e.which == 13) {
     newMessage();
     return false;
   }
 });

 function set_active(elem, uid)
 {
   $('li').each(function(i) {
     $(this).removeClass('active');
   });
   elem.classList.add('active');

   $.ajax({
     url: "{% url 'chat-load-msgs' %}",
     data: {
       'uid': uid
     },
     success: function(data) {
       var msg_box = document.getElementById('message_box_id');
       var contact_name = document.getElementById('contact_name_id');
       var delim = data.lastIndexOf("<ul>") - 1;
       var username = data.substring(0, delim);

       contact_name.innerHTML = username;
       data = data.substring(delim + 1);
       msg_box.innerHTML = data;
     }
   });
 }

</script>
{% endblock %}
